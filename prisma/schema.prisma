// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Document model - stores PDF metadata and processing status
model Document {
  id              String   @id @default(cuid())
  fileName        String
  originalName    String
  fileSize        Int
  fileHash        String?  // For duplicate detection
  pageCount       Int      @default(1)
  status          DocumentStatus @default(PENDING)
  classification  DocumentType?
  classificationConfidence Float?
  errorMessage    String?
  
  // Processing metadata
  processingStartedAt DateTime?
  processingCompletedAt DateTime?
  modelUsed       String?
  
  // Relationships
  extractedData   ExtractedData?
  processedImages ProcessedImage[]
  costMetrics     CostMetrics?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Extracted data from the document
model ExtractedData {
  id          String   @id @default(cuid())
  documentId  String   @unique
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Extracted fields
  name        String?
  address     String?
  postalcode  String?
  city        String?
  birthday    String?
  date        String?
  time        String?
  handwritten Boolean?
  signed      Boolean?
  stamp       String?
  
  // Raw JSON for any additional fields
  rawJson     Json?
  
  // Confidence scores for each field
  confidenceScores Json?
  
  // Overall confidence
  overallConfidence Float?
  
  // Validation flags
  needsReview Boolean @default(false)
  reviewNotes String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Processed images from PDF pages
model ProcessedImage {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  pageNumber  Int
  imagePath   String
  width       Int?
  height      Int?
  dpi         Int      @default(300)
  
  // Preprocessing applied
  rotated     Boolean  @default(false)
  deskewed    Boolean  @default(false)
  enhanced    Boolean  @default(false)
  
  createdAt   DateTime @default(now())

  @@index([documentId])
}

// Cost tracking per document
model CostMetrics {
  id          String   @id @default(cuid())
  documentId  String   @unique
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Token usage
  inputTokens  Int     @default(0)
  outputTokens Int     @default(0)
  
  // Model used
  model        String?
  
  // Cost calculation (in USD cents)
  estimatedCost Float  @default(0)
  
  // Batch processing
  usedBatchApi  Boolean @default(false)
  batchJobId    String?
  
  createdAt    DateTime @default(now())
}

// Batch processing jobs
model BatchJob {
  id          String   @id @default(cuid())
  status      BatchJobStatus @default(PENDING)
  
  // Job details
  documentCount Int
  totalTokens   Int     @default(0)
  estimatedCost Float   @default(0)
  actualCost    Float?
  
  // External batch job reference
  externalJobId String?
  
  // Timing
  submittedAt   DateTime?
  completedAt   DateTime?
  
  errorMessage  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Enums
enum DocumentStatus {
  PENDING
  UPLOADING
  PREPROCESSING
  CLASSIFYING
  EXTRACTING
  COMPLETED
  FAILED
  QUEUED_FOR_BATCH
}

enum DocumentType {
  HANDWRITTEN
  TYPED
  MIXED
  SCANNED
}

enum BatchJobStatus {
  PENDING
  SUBMITTED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
